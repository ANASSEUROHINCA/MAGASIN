<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>EUROHINCA Stock Management</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
:root {
  --color-bg: #f8f9fc;
  --glass-bg: rgba(255,255,255,0.95);
  --glass-border: rgba(40, 80, 220, 0.08);
  --accent: #5b7cf7;
  --accent2: #f7b633;
  --accent-light: #eef2ff;
  --text: #1e293b;
  --text-light: #64748b;
  --success: #10b981;
  --warning: #f59e0b;
  --danger: #ef4444;
  --border: #e2e8f0;
}
* { box-sizing: border-box; }
body {
  font-family: 'Inter', sans-serif;
  background: linear-gradient(135deg,#f0f4ff 0%,#e8ecfa 100%);
  min-height:100vh; margin:0; color: var(--text);
}
.main-container {
  display:flex; max-width:1400px; margin:20px auto; border-radius:16px;
  box-shadow:0 4px 24px rgba(80,90,155,0.08); overflow:hidden; min-height: calc(100vh - 40px);
}
.sidebar {
  width:240px; background:#fff; border-right:1px solid var(--border); 
  display:flex;flex-direction:column; padding:0;
}
.logo-area { text-align:center; padding:24px 16px; border-bottom: 1px solid var(--border);}
.logo { width:48px; border-radius:12px;}
.logo-area h2 { margin:12px 0 0 0; font-size:18px; font-weight:700; color:var(--accent);}
nav ul { list-style:none; padding:16px 12px; margin:0;}
.nav-item { 
  padding:12px 16px; margin:4px 0; border-radius:10px; cursor:pointer; 
  color:var(--text); font-weight:500; font-size:14px;
  transition:all 0.2s; display:flex; align-items:center; gap:10px;
}
.nav-item:hover { background: var(--accent-light); color: var(--accent); }
.nav-item.active { background: var(--accent); color:white; box-shadow:0 2px 8px rgba(91,124,247,0.3);}
.user-info { margin-top:auto; padding:16px; border-top: 1px solid var(--border); font-size:13px; color:var(--text-light);}
.logout { 
  background:#fff; border:1.5px solid var(--accent); color:var(--accent);
  padding:10px 20px; border-radius:8px; font-weight:600; cursor:pointer;
  width:calc(100% - 32px); margin: 12px 16px; font-size:14px; transition:all 0.2s;
}
.logout:hover { background:var(--accent); color:#fff; }
.content-area {
  flex:1; background:var(--color-bg); padding:32px; overflow-y:auto;
}
.panel { display:none;}
.panel.active { display:block;}

.login-overlay {
  position: fixed; top:0; left:0; width:100vw; height:100vh; 
  display:flex; align-items:center; justify-content:center;
  background:rgba(0,0,0,0.4); backdrop-filter:blur(4px);
  z-index:1000;
}
#login-form {
  padding:40px; background:#fff; border-radius:16px;
  box-shadow:0 20px 60px rgba(0,0,0,0.3); min-width:360px;
}
#login-form h2 { font-weight:700; margin:0 0 24px 0; color:var(--accent); font-size:24px;}
#user-select {
  width:100%; font-size:15px; border-radius:8px; padding:12px 16px; 
  margin-bottom:20px; border:1.5px solid var(--border); font-family:inherit;
}
#login-form button {
  width:100%; background:var(--accent); border:none; border-radius:8px; 
  color:#fff; font-weight:600; padding:12px; font-size:15px; cursor:pointer; 
  transition:all 0.2s; font-family:inherit;
}
#login-form button:hover { background:#4c6de6; transform:translateY(-1px); box-shadow:0 4px 12px rgba(91,124,247,0.4);}

.page-header {
  display:flex; justify-content:space-between; align-items:center; margin-bottom:32px;
}
.page-header h2 { margin:0; font-size:28px; font-weight:700; color:var(--text);}
.btn-primary {
  background:var(--accent); color:#fff; border:none; padding:10px 20px;
  border-radius:8px; font-weight:600; cursor:pointer; font-size:14px;
  transition:all 0.2s; display:inline-flex; align-items:center; gap:6px;
  font-family:inherit;
}
.btn-primary:hover { background:#4c6de6; transform:translateY(-1px); box-shadow:0 4px 12px rgba(91,124,247,0.4);}
.btn-secondary {
  background:#fff; color:var(--text); border:1.5px solid var(--border); 
  padding:8px 16px; border-radius:8px; font-weight:500; cursor:pointer; 
  font-size:13px; transition:all 0.2s; font-family:inherit;
}
.btn-secondary:hover { border-color:var(--accent); color:var(--accent); }
.btn-success { background:var(--success); }
.btn-success:hover { background:#059669; }
.btn-warning { background:var(--warning); }
.btn-warning:hover { background:#d97706; }
.btn-danger { background:var(--danger); }
.btn-danger:hover { background:#dc2626; }
.btn-sm { padding:6px 12px; font-size:13px; }

.stats-grid {
  display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); 
  gap: 20px; margin-bottom: 32px;
}
.stat-card {
  background:#fff; border-radius:12px; padding:24px; 
  box-shadow:0 1px 3px rgba(0,0,0,0.05); border:1px solid var(--border);
  transition:all 0.2s;
}
.stat-card:hover { box-shadow:0 4px 12px rgba(0,0,0,0.08); transform:translateY(-2px);}
.stat-card h4 { margin:0 0 8px 0; font-size:13px; font-weight:600; 
  color:var(--text-light); text-transform:uppercase; letter-spacing:0.5px;}
.stat-card .stat { font-size:32px; font-weight:700; color:var(--accent); margin:0;}
.stat-card .label { font-size:12px; color:var(--text-light); margin-top:4px;}

.card {
  background:#fff; border-radius:12px; padding:24px; 
  box-shadow:0 1px 3px rgba(0,0,0,0.05); border:1px solid var(--border);
  margin-bottom:24px;
}
.card-header {
  display:flex; justify-content:space-between; align-items:center; 
  margin-bottom:20px; padding-bottom:16px; border-bottom:1px solid var(--border);
}
.card-header h3 { margin:0; font-size:18px; font-weight:600; color:var(--text);}

.form-grid {
  display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); 
  gap:16px; margin-bottom:20px;
}
.form-group { display:flex; flex-direction:column; }
.form-group label { font-size:13px; font-weight:600; color:var(--text); 
  margin-bottom:6px; display:flex; align-items:center; gap:4px;}
.form-group input, .form-group select {
  padding:10px 12px; border:1.5px solid var(--border); border-radius:8px;
  font-size:14px; font-family:inherit; transition:all 0.2s;
}
.form-group input:focus, .form-group select:focus {
  outline:none; border-color:var(--accent); box-shadow:0 0 0 3px rgba(91,124,247,0.1);
}

.data-table {
  width:100%; border-collapse:separate; border-spacing:0; font-size:14px;
}
.data-table thead th {
  background:var(--accent-light); color:var(--accent); font-weight:600;
  padding:12px 16px; text-align:left; font-size:13px;
  border-bottom:2px solid var(--accent); position:sticky; top:0;
}
.data-table thead th:first-child { border-radius:8px 0 0 0;}
.data-table thead th:last-child { border-radius:0 8px 0 0;}
.data-table tbody td {
  padding:14px 16px; border-bottom:1px solid var(--border);
}
.data-table tbody tr { transition:background 0.15s; }
.data-table tbody tr:hover { background:var(--accent-light); }
.data-table tbody tr:last-child td { border-bottom:none; }

.badge {
  display:inline-block; padding:4px 10px; border-radius:12px; 
  font-size:12px; font-weight:600;
}
.badge-success { background:#d1fae5; color:#065f46; }
.badge-warning { background:#fef3c7; color:#92400e; }
.badge-danger { background:#fee2e2; color:#991b1b; }
.badge-info { background:#dbeafe; color:#1e40af; }

.modal {
  position:fixed; top:0; left:0; width:100vw; height:100vh;
  background:rgba(0,0,0,0.5); backdrop-filter:blur(4px);
  display:none; align-items:center; justify-content:center; z-index:999;
}
.modal.active { display:flex; }
.modal-content {
  background:#fff; border-radius:16px; padding:32px; 
  max-width:600px; width:90%; max-height:90vh; overflow-y:auto;
  box-shadow:0 20px 60px rgba(0,0,0,0.3);
}
.modal-header {
  display:flex; justify-content:space-between; align-items:center;
  margin-bottom:24px; padding-bottom:16px; border-bottom:1px solid var(--border);
}
.modal-header h3 { margin:0; font-size:20px; font-weight:700;}
.modal-close {
  background:none; border:none; font-size:24px; cursor:pointer; 
  color:var(--text-light); width:32px; height:32px; border-radius:8px;
  display:flex; align-items:center; justify-content:center; transition:all 0.2s;
}
.modal-close:hover { background:var(--accent-light); color:var(--accent); }

.qty-control {
  display:flex; align-items:center; gap:12px;
}
.qty-btn {
  width:36px; height:36px; border:1.5px solid var(--border); 
  background:#fff; border-radius:8px; cursor:pointer; font-size:18px;
  font-weight:600; transition:all 0.2s; display:flex; align-items:center;
  justify-content:center;
}
.qty-btn:hover { border-color:var(--accent); color:var(--accent); background:var(--accent-light); }
.qty-display {
  font-size:20px; font-weight:700; min-width:60px; text-align:center;
  padding:8px 16px; background:var(--accent-light); border-radius:8px;
  color:var(--accent);
}

.search-box {
  position:relative; max-width:300px;
}
.search-box input {
  width:100%; padding:10px 40px 10px 16px; border:1.5px solid var(--border);
  border-radius:8px; font-size:14px; font-family:inherit;
}
.search-box::after {
  content:'üîç'; position:absolute; right:12px; top:50%; 
  transform:translateY(-50%); font-size:16px; pointer-events:none;
}

.empty-state {
  text-align:center; padding:60px 20px; color:var(--text-light);
}
.empty-state-icon { font-size:64px; margin-bottom:16px; opacity:0.5;}
.empty-state h3 { margin:0 0 8px 0; font-size:18px; color:var(--text);}
.empty-state p { margin:0; font-size:14px;}

.action-buttons {
  display:flex; gap:8px; justify-content:flex-end;
}

.alert {
  padding:12px 16px; border-radius:8px; margin-bottom:20px; font-size:14px;
  display:flex; align-items:center; gap:12px;
}
.alert-success { background:#d1fae5; color:#065f46; border:1px solid #86efac;}
.alert-warning { background:#fef3c7; color:#92400e; border:1px solid #fde68a;}
.alert-danger { background:#fee2e2; color:#991b1b; border:1px solid #fecaca;}

@media (max-width:920px){
  .main-container{ flex-direction:column;}
  .sidebar{ width:100%; }
  nav ul { display:flex; overflow-x:auto; padding:8px;}
  .nav-item { white-space:nowrap;}
  .content-area { padding:16px;}
  .stats-grid { grid-template-columns:1fr 1fr;}
  .form-grid { grid-template-columns:1fr;}
}
  </style>
</head>
<body>
  <div class="main-container" id="app">
    <aside class="sidebar">
      <div class="logo-area">
        <img src="https://img.icons8.com/glyph-neue/64/construction.png" class="logo" alt="Logo"/>
        <h2>EUROHINCA</h2>
      </div>
      <nav>
        <ul>
          <li class="nav-item active" data-tab="dashboard">üìä Dashboard</li>
          <li class="nav-item" data-tab="oils">üõ¢Ô∏è Huiles</li>
          <li class="nav-item" data-tab="chemicals">‚öóÔ∏è Chimie</li>
          <li class="nav-item" data-tab="stock">üì¶ Mat√©riel</li>
          <li class="nav-item" data-tab="sortie">üì§ Sorties</li>
          <li class="nav-item" data-tab="gasoil">‚õΩ Gasoil</li>
          <li class="nav-item" data-tab="history">üìú Historique</li>
        </ul>
      </nav>
      <div class="user-info" id="user-info"></div>
      <button id="logout-btn" class="logout">D√©connexion</button>
    </aside>
    <main class="content-area">
      <section id="dashboard-panel" class="panel active"></section>
      <section id="oils-panel" class="panel"></section>
      <section id="chemicals-panel" class="panel"></section>
      <section id="stock-panel" class="panel"></section>
      <section id="sortie-panel" class="panel"></section>
      <section id="gasoil-panel" class="panel"></section>
      <section id="history-panel" class="panel"></section>
    </main>
  </div>

  <div id="login-overlay" class="login-overlay">
    <form id="login-form">
      <h2>Connexion</h2>
      <select id="user-select" required>
        <option value="" disabled selected>Choisissez votre nom...</option>
        <option>Issam Abahmane</option>
        <option>Mehdi Kridid</option>
        <option>Yassine Faradi</option>
        <option>Zakharia Essabir</option>
        <option>Admin</option>
      </select>
      <button type="submit">Se connecter</button>
    </form>
  </div>

  <!-- Modals -->
  <div id="edit-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modal-title">Modifier le stock</h3>
        <button class="modal-close" onclick="closeModal()">&times;</button>
      </div>
      <div id="modal-body"></div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
  <script>
// Firebase Init
const firebaseConfig = {
    apiKey: "AIzaSyChTXTsCZZxFGZyheznVWlQ_jO8LroXZbY",
    authDomain: "stock-fdfe7.firebaseapp.com",
    projectId: "stock-fdfe7",
    storageBucket: "stock-fdfe7.firebasestorage.app",
    messagingSenderId: "771102774872",
    appId: "1:771102774872:web:c9cb25329927ec71a09c2d"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// User Management
let currentUser = null;
function getUser(){ return localStorage.getItem('eurohinca_user')||""; }
function setUser(name){ localStorage.setItem('eurohinca_user', name); }
function nowDate(){ return new Date().toISOString().substr(0,10);}
function nowTime(){ return new Date().toTimeString().substr(0,8);}

// Login
const overlay = document.getElementById('login-overlay');
const form = document.getElementById('login-form');
checkLogin();

form.onsubmit = e => {
  e.preventDefault();
  const user = document.getElementById('user-select').value;
  if (!user) return;
  setUser(user); currentUser = user;
  location.reload();
};

document.getElementById('logout-btn').onclick = ()=>{ 
  localStorage.removeItem('eurohinca_user'); 
  location.reload(); 
}

function checkLogin() {
  const u = getUser();
  if (!u) { overlay.style.display = 'flex'; }
  else { 
    overlay.style.display = 'none'; 
    document.getElementById('user-info').textContent = u;
    currentUser = u; 
  }
}

// Navigation
const navItems = document.querySelectorAll('.nav-item');
const panels = document.querySelectorAll('.panel');
navItems.forEach(item=>{
  item.onclick = ()=>{
    navItems.forEach(i=>i.classList.remove('active'));
    panels.forEach(p=>p.classList.remove('active'));
    item.classList.add('active');
    document.getElementById(item.dataset.tab+'-panel').classList.add('active');
    loadPanel(item.dataset.tab);
  };
});

// Modal Functions
function closeModal() {
  document.getElementById('edit-modal').classList.remove('active');
}

function openEditModal(collection, docId, currentQty, itemName) {
  const modal = document.getElementById('edit-modal');
  document.getElementById('modal-title').textContent = `Modifier: ${itemName}`;
  document.getElementById('modal-body').innerHTML = `
    <div class="form-group">
      <label>Quantit√© actuelle: <strong>${currentQty}</strong></label>
    </div>
    <div class="form-group">
      <label>Nouvelle quantit√©</label>
      <div class="qty-control">
        <button type="button" class="qty-btn" onclick="changeQty(-10)">-10</button>
        <button type="button" class="qty-btn" onclick="changeQty(-1)">-1</button>
        <div class="qty-display" id="new-qty">${currentQty}</div>
        <button type="button" class="qty-btn" onclick="changeQty(1)">+1</button>
        <button type="button" class="qty-btn" onclick="changeQty(10)">+10</button>
      </div>
    </div>
    <div class="form-group">
      <label>Ou entrer directement:</label>
      <input type="number" id="direct-qty" value="${currentQty}" min="0" 
        onchange="document.getElementById('new-qty').textContent=this.value">
    </div>
    <div class="action-buttons" style="margin-top:24px;">
      <button class="btn-secondary" onclick="closeModal()">Annuler</button>
      <button class="btn-primary" onclick="saveQty('${collection}','${docId}')">
        Enregistrer
      </button>
    </div>
  `;
  modal.classList.add('active');
}

function changeQty(delta) {
  const display = document.getElementById('new-qty');
  const input = document.getElementById('direct-qty');
  let current = parseInt(display.textContent);
  let newVal = Math.max(0, current + delta);
  display.textContent = newVal;
  input.value = newVal;
}

async function saveQty(collection, docId) {
  const newQty = parseInt(document.getElementById('direct-qty').value);
  await db.collection(collection).doc(docId).update({ qty: newQty });
  await db.collection("log_activity").add({
    act: "Modification quantit√©",
    collection: collection,
    docId: docId,
    newQty: newQty,
    user: getUser(),
    timestamp: firebase.firestore.FieldValue.serverTimestamp()
  });
  closeModal();
  showAlert('Quantit√© mise √† jour avec succ√®s!', 'success');
}

function showAlert(message, type = 'success') {
  const alertDiv = document.createElement('div');
  alertDiv.className = `alert alert-${type}`;
  alertDiv.textContent = message;
  const activePanel = document.querySelector('.panel.active');
  activePanel.insertBefore(alertDiv, activePanel.firstChild);
  setTimeout(() => alertDiv.remove(), 3000);
}

// Panel Loading
let panelLoaded = {};
async function loadPanel(name) {
  if(panelLoaded[name]) return;
  switch(name){
    case "dashboard": await loadDashboard(); break;
    case "oils": await loadOils(); break;
    case "chemicals": await loadChemicals(); break;
    case "stock": await loadStock(); break;
    case "sortie": await loadSortie(); break;
    case "gasoil": await loadGasoil(); break;
    case "history": await loadHistory(); break;
  }
  panelLoaded[name]=true;
}

// Dashboard
async function loadDashboard(){
  const dst = document.getElementById('dashboard-panel');
  dst.innerHTML = `
    <div class="page-header">
      <h2>Tableau de Bord</h2>
    </div>
    <div class="stats-grid">
      <div class="stat-card">
        <h4>Huiles & Graisses</h4>
        <div class="stat" id="stat-oil">0</div>
        <div class="label">Total unit√©s</div>
      </div>
      <div class="stat-card">
        <h4>Bentonite & Chimie</h4>
        <div class="stat" id="stat-chem">0</div>
        <div class="label">Total unit√©s</div>
      </div>
      <div class="stat-card">
        <h4>Stock Mat√©riel</h4>
        <div class="stat" id="stat-stock">0</div>
        <div class="label">Total pi√®ces</div>
      </div>
      <div class="stat-card">
        <h4>Gasoil</h4>
        <div class="stat" id="stat-diesel">0</div>
        <div class="label">Litres disponibles</div>
      </div>
    </div>
    <div class="card">
      <div class="card-header">
        <h3>Activit√© r√©cente</h3>
      </div>
      <div id="recent-activity"></div>
    </div>
  `;
  
  // Load stats
  db.collection("inventory_oil").get().then(q=>{
    const tot = q.docs.reduce((s,doc)=>s+(Number(doc.data().qty)||0),0);
    document.getElementById("stat-oil").textContent = tot;
  });
  db.collection("inventory_ben").get().then(q=>{
    const tot = q.docs.reduce((s,doc)=>s+(Number(doc.data().qty)||0),0);
    document.getElementById("stat-chem").textContent = tot;
  });
  db.collection("inventory_stock").get().then(q=>{
    const tot = q.docs.reduce((s,doc)=>s+(Number(doc.data().qty)||0),0);
    document.getElementById("stat-stock").textContent = tot;
  });
  db.collection("gasoil_total").doc("global").get().then(doc=>{
    document.getElementById("stat-diesel").textContent = 
      doc.exists ? (doc.data().qty||0) : 0;
  });

  // Recent activity
  db.collection("log_activity").orderBy("timestamp","desc").limit(5).get().then(qs=>{
    const html = qs.docs.map(doc=>{
      const d = doc.data();
      return `<div style="padding:12px 0; border-bottom:1px solid var(--border);">
        <div style="font-weight:600; color:var(--text);">${d.act||'Action'}</div>
        <div style="font-size:13px; color:var(--text-light); margin-top:4px;">
          ${d.user||''} ‚Ä¢ ${d.timestamp ? new Date(d.timestamp.seconds*1000).toLocaleString() : ''}
        </div>
      </div>`;
    }).join('');
    document.getElementById('recent-activity').innerHTML = html || 
      '<div class="empty-state"><p>Aucune activit√© r√©cente</p></div>';
  });
}

// Oils Panel
async function loadOils(){
  const dst = document.getElementById('oils-panel');
  dst.innerHTML = `
    <div class="page-header">
      <h2>Huiles & Graisses</h2>
      <button class="btn-primary" onclick="showAddOilForm()">
        ‚ûï Ajouter un produit
      </button>
    </div>
    <div class="card" id="add-oil-card" style="display:none;">
      <div class="card-header">
        <h3>Nouveau produit</h3>
      </div>
      <form id="oil-form">
        <div class="form-grid">
          <div class="form-group">
            <label>Type de produit</label>
            <input type="text" id="oil-type" required placeholder="Ex: TOTAL AZOLLA ZS 68">
          </div>
          <div class="form-group">
            <label>Quantit√© initiale</label>
            <input type="number" id="oil-qty" required min="0" value="0">
          </div>
          <div class="form-group">
            <label>Unit√©</label>
            <select id="oil-unit">
              <option>L</option>
              <option>kg</option>
              <option>unit√©</option>
            </select>
          </div>
          <div class="form-group">
            <label>Seuil d'alerte</label>
            <input type="number" id="oil-alert" min="0" value="10">
          </div>
        </div>
        <div class="action-buttons">
          <button type="button" class="btn-secondary" onclick="hideAddOilForm()">Annuler</button>
          <button type="submit" class="btn-primary">Ajouter</button>
        </div>
      </form>
    </div>
    <div class="card">
      <div class="card-header">
        <h3>Inventaire</h3>
        <div class="search-box">
          <input type="text" id="oil-search" placeholder="Rechercher...">
        </div>
      </div>
      <table class="data-table">
        <thead>
          <tr>
            <th>Produit</th>
            <th>Quantit√©</th>
            <th>Unit√©</th>
            <th>Alerte</th>
            <th>Statut</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="oil-tbody"></tbody>
      </table>
    </div>
  `;

  const form = document.getElementById('oil-form');
  const tbody = document.getElementById('oil-tbody');

  // Load inventory
  db.collection("inventory_oil").onSnapshot(qs=>{
    if(qs.empty) {
      tbody.innerHTML = '<tr><td colspan="6" class="empty-state"><p>Aucun produit</p></td></tr>';
      return;
    }
    
    // Group by type and sum quantities
    const grouped = {};
    qs.docs
