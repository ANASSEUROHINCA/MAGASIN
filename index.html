<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>EUROHINCA Inventory Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
  <style>
:root {
  --bg: #ececf6;
  --panel: #fff;
  --accent: #5A51E8;
  --accent2: #FEA727;
  --accent3: #F6F8FB;
  --gray: #b6bac8;
  --fullness-low: #fe8b71;
  --fullness-mid: #f7b633;
  --fullness-ok: #90e867;
  --dark: #373a47;
}
body {
  background: var(--bg);
  margin:0; font-family: 'Inter',sans-serif;
}
#app-wrap {
  margin:0 auto; max-width:1420px; display:flex; min-height:100vh;
}
#sidebar {
  background: var(--panel); min-width:74px; box-shadow:2px 0 27px #d1d1e8cc;
  display:flex; flex-direction:column; align-items:center; padding:1em 0;
}
#sidebar .logo {
  margin: 12px 0 14px 0; width:50px; border-radius:12px; box-shadow:0 2px 12px #dee1fa34;
}
#sidebar .side-nav {margin-top:17px;}
#sidebar .sidebtn {
  background: none; border:none; cursor:pointer;
  padding:13px 0; width:56px; border-radius:12px; margin-bottom:6px;
  display:block; text-align:center; color:var(--accent);
  transition:.13s; font-size: 23px;
}
#sidebar .sidebtn.active,#sidebar .sidebtn:hover {background:var(--accent3);}
#sidebar .userInfo {
  margin-top:auto; font-size:.97em; color:#6e7d9a;
  border-top:1px solid #f3f3fa; width:100%; text-align:center; padding:.8em 0 .2em 0;
}
#main-panel {
  background: var(--bg); flex:1; padding:34px 40px 24px 38px;
}
h1 { font-size: 1.55em; color: var(--accent); margin-bottom:3px;}
.panel-row {display: flex;gap:2.3em;}
.panel-card {
  background: var(--panel); border-radius:18px; box-shadow: 0 2px 14px #e0e3eb33;
  margin-bottom:29px; padding:1.54em 2.2em 2em 2.1em; width:100%;
}
.section-title {
  display:flex; align-items:center; gap:1.2em; font-size:1.3em; font-weight:700;
  margin-bottom:7px; color: var(--accent);
}
.section-title img {width: 34px;}
.filter-bar {display:flex;gap:11px;align-items:center;margin:2px 0 19px 0;}
.filter-bar select, .filter-bar input {padding:.5em 1.2em;border-radius:14px;border:1px solid #e9e7f1;font-size:1em;background:#f7f7fc;}
.addProductBtn {
  background:linear-gradient(90deg,var(--accent)35%,var(--accent2)100%);
  color:#fff;border:none; font-weight:700;border-radius:11px;
  padding:.4em 1.4em;font-size:1em;margin-left:auto;cursor:pointer;
}
.product-list {margin:1.1em 0;}
.product-card {
  background: var(--accent3); border-radius:17px;
  box-shadow:0 1.1px 9px #e0e7e541; display:flex; align-items:center; gap:1.25em;
  padding:1em 1.6em; margin-bottom:13px;
}
.prod-img {
  width:60px; height:60px; object-fit:cover; border-radius:10px;background:#f9f9ff;
  box-shadow:0 2px 12px #dee1fa1a;
}
.prod-details { flex:1;}
.prod-name { font-weight:700; font-size:1.12em;}
.prod-cat { color: #7e97c7; background: #e9e9f6; padding:2px 8px;
  border-radius:8px; display:inline-block; margin:.1em 0 5px 0;font-size:.95em;}
.prod-desc { font-size: .96em; color: #585858;}
.prod-meter-bar-wrap {
  background: #E7E7F1; border-radius:8px; width:130px; height:10px; overflow:hidden; display:inline-block; margin-right:.5em;vertical-align:middle;
}
.prod-meter-bar {
  height:100%;border-radius:8px;transition:.27s;
}
.prod-meter {display:flex;align-items:center;gap:1em;margin-top:6px;}
.prod-meter .meter-percent { font-size: .92em; color: var(--accent); }
.prod-meter .meter-label { color: #8a8e99; font-size: .95em;}
.prod-actions {display:flex;gap:.5em;}
.prod-actions button {
  border:none; border-radius:9px; background:#fff; font-size:1.1em;
  box-shadow:0 1px 8px #e9e9f92a;color:var(--accent);cursor:pointer; padding:.13em 1em;font-weight:600;
}
.prod-actions button:hover{background:var(--accent2);color:#fff;}
#modal-bg {
  position:fixed;top:0;left:0;width:100vw;height:100vh;background:#43557c53;z-index:50;display:none;align-items:center;justify-content:center;
}
#edit-modal {
  background:var(--panel);min-width:330px;max-width:380px;padding:2em 2.3em;border-radius:22px;box-shadow:2px 10px 32px #adaedca9;
  display: flex; flex-direction:column;align-items:center;
}
#edit-modal label{font-size:1.04em;margin-top:7px;}
#edit-modal input,#edit-modal textarea{
  background:#f8f9fc;border-radius:12px;border:1px solid #dddee8;padding:.7em 1.2em;margin-top:4px;margin-bottom:10px;width:100%;
}
#edit-modal input[type="url"],#edit-modal input[type="text"],#edit-modal textarea{font-size:1.05em;}
#edit-modal .modal-btn-row{width:100%;display:flex;gap:.6em;}
#edit-modal button{border:none;border-radius:12px;background:var(--accent);color:#fff;padding:.47em 1.5em;font-weight:700;cursor:pointer;}
#edit-modal button.cancel{background:#efd;}
#edit-modal button.delete{background:var(--fullness-low);}
#modal-bg.show{display:flex;}
::-webkit-scrollbar {width:7px;height:7px;}
::-webkit-scrollbar-thumb{background:#e1e2f6;border-radius:9px;}
  </style>
</head>
<body>
<div id="app-wrap">
  <div id="sidebar">
    <img src="https://img.icons8.com/glyph-neue/64/construction.png" class="logo" alt="Logo"/>
    <div class="side-nav">
      <button class="sidebtn active" data-panel="dashboard" title="Dashboard"><img src="https://img.icons8.com/ios-filled/25/5A51E8/combo-chart.png"/></button>
      <button class="sidebtn" data-panel="oils" title="Huiles & Graisses"><img src="https://img.icons8.com/ios-filled/25/fea727/oil.png"/></button>
      <button class="sidebtn" data-panel="chemicals" title="Chimie"><img src="https://img.icons8.com/ios-filled/25/8b95c9/chemical.png"/></button>
      <button class="sidebtn" data-panel="stock" title="Matériel"><img src="https://img.icons8.com/ios-filled/25/90e867/toolbox.png"/></button>
      <button class="sidebtn" data-panel="gasoil" title="Gasoil"><img src="https://img.icons8.com/ios-filled/25/fe8b71/fuel-tank.png"/></button>
      <button class="sidebtn" data-panel="history" title="Historique"><img src="https://img.icons8.com/ios-filled/25/b6bac8/list.png"/></button>
    </div>
    <div class="userInfo" id="sidebar-user"></div>
    <button id="logoutBtn" style="margin-bottom:12px;background:var(--accent3);color:var(--accent);border:none;padding:.4em 1.4em;border-radius:10px;">Déconnexion</button>
  </div>
  <div id="main-panel">
    <div id="dashboard-panel" class="main-section"></div>
    <div id="oils-panel" class="main-section" style="display:none"></div>
    <div id="chemicals-panel" class="main-section" style="display:none"></div>
    <div id="stock-panel" class="main-section" style="display:none"></div>
    <div id="gasoil-panel" class="main-section" style="display:none"></div>
    <div id="history-panel" class="main-section" style="display:none"></div>
  </div>
</div>
<!-- Modal BG + Form for add/edit -->
<div id="modal-bg">
  <form id="edit-modal">
    <h2 id="modal-title">Produit</h2>
    <label>Nom<input type="text" id="prod-name" required></label>
    <label>Catégorie<input type="text" id="prod-cat"></label>
    <label>Quantité<input type="number" id="prod-qty" min="0" required></label>
    <label>Qte max<input type="number" id="prod-maxqty" min="1"></label>
    <label>Description<textarea id="prod-desc"></textarea></label>
    <label>Image URL<input type="url" id="prod-img"></label>
    <div class="modal-btn-row">
      <button id="modal-save" type="submit">Enregistrer</button>
      <button type="button" id="modal-cancel" class="cancel">Annuler</button>
      <button type="button" id="modal-delete" class="delete" style="display:none">Suppr.</button>
    </div>
  </form>
</div>
<!-- Login Overlay -->
<div id="login-overlay" style="position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:99;background:#ececf6e0;display:flex;align-items:center;justify-content:center;">
  <form id="login-form" style="background:#fff;padding:2.4em 2.2em;border-radius:19px;box-shadow:0 2px 42px #adaedc34;min-width:330px;text-align:center;">
    <h2 style="color:var(--accent)">Connectez-vous</h2>
    <select id="user-select" required style="padding:.8em 1.3em;margin-bottom:1.2em;border-radius:11px;">
      <option value="" disabled selected>Choisissez votre nom...</option>
      <option>Issam Abahmane</option>
      <option>Mehdi Kridid</option>
      <option>Yassine Faradi</option>
      <option>Zakharia Essabir</option>
      <option>Admin</option>
    </select>
    <br>
    <button type="submit" style="background:var(--accent2);color:#fff;padding:.8em 2.3em;border:none;border-radius:9px;font-weight:700;font-size:1.08em;">Connexion</button>
  </form>
</div>
<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
<script>
// ==== FIREBASE INIT
const firebaseConfig = {
    apiKey: "AIzaSyChTXTsCZZxFGZyheznVWlQ_jO8LroXZbY",
    authDomain: "stock-fdfe7.firebaseapp.com",
    projectId: "stock-fdfe7",
    storageBucket: "stock-fdfe7.firebasestorage.app",
    messagingSenderId: "771102774872",
    appId: "1:771102774872:web:c9cb25329927ec71a09c2d"
};
firebase.initializeApp(firebaseConfig); const db = firebase.firestore();

// ==== USER LOGIN
let currentUser = null;
function getUser(){ return localStorage.getItem('eurohinca_user')||""; }
function setUser(name){ localStorage.setItem('eurohinca_user', name); }
function nowDate(){ return (new Date()).toISOString().substr(0,10);}
document.getElementById("login-form").onsubmit = e=>{
  e.preventDefault();
  const user = document.getElementById('user-select').value;
  if(user){ setUser(user); currentUser=user; document.getElementById('login-overlay').style.display='none'; initApp(); }
};
document.getElementById("logoutBtn").onclick=()=>{
  localStorage.removeItem('eurohinca_user'); location.reload();
};
function checkLogin(){
  if (!getUser()){ document.getElementById('login-overlay').style.display="flex"; }
  else{ 
    currentUser = getUser(); document.getElementById('login-overlay').style.display="none";
    document.getElementById('sidebar-user').textContent = currentUser;
    initApp();
  }
}
checkLogin();

// ==== NAVIGATION
let currentPanel = "dashboard";
document.querySelectorAll('.sidebtn').forEach(btn=>{
  btn.onclick=()=>{
    document.querySelectorAll('.sidebtn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    document.querySelectorAll('.main-section').forEach(sec=>sec.style.display='none');
    document.getElementById(btn.dataset.panel+'-panel').style.display='block';
    currentPanel=btn.dataset.panel;
    loadPanel(currentPanel);
  }
});

// ==== MODAL + PRODUCT FORM
function closeModal(){
  document.getElementById('modal-bg').classList.remove('show');
  document.getElementById("edit-modal").reset();
}
document.getElementById('modal-cancel').onclick=closeModal;

// ==== DATA: Default Images for Categories
const catImages = {
  "Diesel":"https://img.icons8.com/fluency/64/gas-station.png",
  "Gasoil":"https://img.icons8.com/3d-fluency/64/fuel-tank.png",
  "Oil":"https://img.icons8.com/color/64/engine-oil.png",
  "Chemicals":"https://img.icons8.com/color/64/test-tube.png",
  "Parts":"https://img.icons8.com/sf-regular-filled/64/90e867/bolts.png",
  "Stock":"https://img.icons8.com/sf-regular-filled/64/fea727/toolbox.png"
};

// ==== PANEL HANDLERS ====
function loadPanel(panel){
  switch(panel){
    case "dashboard":loadDashboard();break;
    case "oils":loadProductsPanel("inventory_oil","Oils","Huiles & Graisses","Oil");break;
    case "chemicals":loadProductsPanel("inventory_ben","Chemicals","Chimie","Chemicals");break;
    case "stock":loadProductsPanel("inventory_stock","Parts","Stock Matériel","Parts");break;
    case "gasoil":loadGasoilPanel();break;
    case "history":loadHistoryPanel();break;
  }
}
// === DASHBOARD PANEL ===
function loadDashboard(){
  const dst = document.getElementById("dashboard-panel");
  dst.innerHTML = `<h1>Tableau de Bord</h1>
  <div class="panel-row">
    <div class="panel-card" id="dash-oil-card"><div style="font-size:1.2em;font-weight:650;color:var(--accent)">Huiles</div><div id="dash-oil"></div></div>
    <div class="panel-card" id="dash-chem-card"><div style="font-size:1.2em;font-weight:650;color:var(--accent)">Chimie</div><div id="dash-chem"></div></div>
    <div class="panel-card" id="dash-stock-card"><div style="font-size:1.2em;font-weight:650;color:var(--accent)">Pièces</div><div id="dash-stock"></div></div>
    <div class="panel-card" id="dash-gasoil-card"><div style="font-size:1.2em;font-weight:650;color:var(--accent2)">Diesel (Gasoil)</div><div id="dash-gasoil"></div></div>
  </div>`;
  dashProductSummary("inventory_oil","dash-oil-card","dash-oil","Oils","engine-oil.png");
  dashProductSummary("inventory_ben","dash-chem-card","dash-chem","Chemicals","test-tube.png");
  dashProductSummary("inventory_stock","dash-stock-card","dash-stock","Parts","toolbox.png");
  dashProductSummaryGasoil("dash-gasoil-card","dash-gasoil");
}
function dashProductSummary(coll,cardId,elId,label,img){
  db.collection(coll).get().then(q=>{
    const tot = q.docs.reduce((s,doc)=>s+(Number(doc.data().qty)||0),0);
    document.getElementById(elId).innerHTML=
      `<img src="https://img.icons8.com/color/48/${img}" style="vertical-align:middle;">
       <span style="font-size:1.32em;font-weight:700;">${tot}</span> <span style="color:#99a">en stock</span>`;
  });
}
function dashProductSummaryGasoil(cardId,elId){
  db.collection("gasoil_total").doc("global").get().then(doc=>{
    let qty = doc.exists?doc.data().qty||0:0;
    let maxQty = doc.exists?doc.data().maxQty||40000:40000;
    let percent = Math.floor((qty/maxQty)*100);
    let barcolor = percent>66? "var(--fullness-ok)" : percent>33? "var(--fullness-mid)" : "var(--fullness-low)";
    document.getElementById(elId).innerHTML = `
      <img src="https://img.icons8.com/3d-fluency/64/fuel-tank.png" style="vertical-align:middle;">
      <div class="prod-meter-bar-wrap" style="width:120px;display:inline-block;"><div class="prod-meter-bar" style="width:${percent}%;background:${barcolor}"></div></div>
      <span class="meter-percent">${Math.round(percent)}%</span>
      <br><span style="font-weight:700;font-size:1.16em;color:var(--accent2);margin-left:4px;">${qty} L / ${maxQty} L</span>
    `;
  });
}

// === GENERIC PRODUCTS ("Oils"/"Chemicals"/"Stock/Parts") ===
function loadProductsPanel(coll,cat,section,defcat){
  const dst = document.getElementById(coll.replace('inventory_','')+'-panel');
  dst.innerHTML = `<div class="panel-card"><div class="section-title">
     <img src="${catImages[defcat]||catImages["Stock"]}">${section}
    <button class="addProductBtn" id="add-prod-btn">+ Ajouter produit</button>
  </div>
  <div class="filter-bar">
    <input type="search" id="searchbar" placeholder="Recherche nom ou catégorie...">
  </div>
  <div class="product-list" id="prod-list"></div>
  </div>`;
  // Filtering/search
  let allProds = [];
  function renderList(list){
    const prodList = document.getElementById('prod-list');
    prodList.innerHTML = (list.length)?
      list.map(d=>productCardHTML(d,coll)).join('')
      : `<div style="padding:1.6em;text-align:center;color:#888">Aucun produit!</div>`;
    // Attach edit
    prodList.querySelectorAll('.prod-actions .editBtn').forEach((btn,i)=>{
      btn.onclick = ()=>showEditModal(list[i],coll);
    });
    prodList.querySelectorAll('.prod-actions .deleteBtn').forEach((btn,i)=>{
      btn.onclick = ()=>deleteProduct(list[i],coll);
    });
  }
  db.collection(coll).orderBy("date","desc").onSnapshot(qs=>{
    allProds = qs.docs.map(doc=>({...doc.data(),_id:doc.id}));
    renderList(allProds);
  });
  document.getElementById('searchbar').oninput = e=>{
    const val = e.target.value.toLowerCase();
    renderList(allProds.filter(d=>
      (d.type||d.des||d.nom||'').toLowerCase().includes(val) || (d.cat||'').toLowerCase().includes(val)
    ));
  };
  // Add product
  document.getElementById('add-prod-btn').onclick=()=>showEditModal(null,coll);
}

// === PRODUCT CARD HTML
function productCardHTML(prod,coll){
  const name = prod.type||prod.nom||prod.des||"";
  const cat = prod.cat||prod.category||"";
  const desc = prod.desc||"";
  const qty = Number(prod.qty)||0;
  const maxQty = Number(prod.maxQty)|| (coll=="gasoil_total"?40000:1000);
  const percent = Math.min(100, Math.round((qty/(maxQty||1))*100));
  let barcolor = percent>66? "var(--fullness-ok)" : percent>33? "var(--fullness-mid)" : "var(--fullness-low)";
  const img = prod.image||catImages[cat]||catImages["Stock"];
  return `
    <div class="product-card">
      <img class="prod-img" src="${img}" alt="${name}">
      <div class="prod-details">
        <div class="prod-name">${name}</div>
        <div class="prod-cat">${cat}</div>
        <div class="prod-desc">${desc}</div>
        <div class="prod-meter">
          <span class="meter-label">Stock:</span>
          <span>${qty} / ${maxQty}</span>
          <div class="prod-meter-bar-wrap"><div class="prod-meter-bar" style="width:${percent}%;background:${barcolor}"></div></div>
          <span class="meter-percent">${percent}%</span>
        </div>
      </div>
      <div class="prod-actions">
        <button class="editBtn">Editer</button>
        <button class="deleteBtn">Suppr.</button>
      </div>
    </div>
  `;
}
// === EDIT PRODUCT MODAL ===
function showEditModal(prod,coll){
  document.getElementById("modal-bg").classList.add("show");
  let form = document.getElementById("edit-modal");
  form.reset();
  document.getElementById("modal-title").textContent = prod ? "Modifier produit":"Ajouter produit";
  document.getElementById("modal-delete").style.display = prod?"inline-block":"none";
  // Fill values
  document.getElementById("prod-name").value = prod?(prod.type||prod.nom||prod.des):"";
  document.getElementById("prod-cat").value = prod?(prod.cat||prod.category):"";
  document.getElementById("prod-qty").value = prod?prod.qty:0;
  document.getElementById("prod-maxqty").value = prod?prod.maxQty||1000:"";
  document.getElementById("prod-desc").value = prod?prod.desc||"":"";
  document.getElementById("prod-img").value = prod?prod.image||"":"";
  // Save
  form.onsubmit = async function(evt){
    evt.preventDefault();
    let data = {
      type: document.getElementById("prod-name").value,
      cat: document.getElementById("prod-cat").value,
      qty: Number(document.getElementById("prod-qty").value),
      maxQty: Number(document.getElementById("prod-maxqty").value),
      desc: document.getElementById("prod-desc").value,
      image: document.getElementById("prod-img").value,
      date: nowDate(),
      user: getUser()
    };
    if(prod && prod._id){
      await db.collection(coll).doc(prod._id).set({...prod,...data});
      await db.collection("log_activity").add({act:"Maj produit",...data,timestamp:firebase.firestore.FieldValue.serverTimestamp()});
    }else{
      await db.collection(coll).add(data);
      await db.collection("log_activity").add({act:"Ajout produit",...data,timestamp:firebase.firestore.FieldValue.serverTimestamp()});
    }
    closeModal();
  };
  // Delete
  document.getElementById("modal-delete").onclick = async function(){
    if(prod && prod._id){
      await db.collection(coll).doc(prod._id).delete();
      await db.collection("log_activity").add({act:"Suppression produit",...prod,timestamp:firebase.firestore.FieldValue.serverTimestamp()});
      closeModal();
    }
  };
}

// === DELETE PRODUCT (Quick)
async function deleteProduct(prod,coll){
  if(confirm("Supprimer ce produit?")){
    await db.collection(coll).doc(prod._id).delete();
    await db.collection("log_activity").add({act:"Suppression produit",...prod,timestamp:firebase.firestore.FieldValue.serverTimestamp()});
  }
}

// === GASOIL PANEL (Special: fullness bar, edit total, etc) ===
function loadGasoilPanel(){
  const dst = document.getElementById("gasoil-panel");
  dst.innerHTML = `
    <div class="panel-card">
      <div class="section-title">
        <img src="https://img.icons8.com/3d-fluency/64/fuel-tank.png">
        Gasoil (Diesel) Total & Consommation
        <button class="addProductBtn" id="add-gas-btn">Editer Total</button>
      </div>
      <div id="gas-detail"></div>
    </div>
    <div class="panel-card">
      <div class="section-title"><img src="https://img.icons8.com/fluency/48/gas-station.png">Consommations</div>
      <form id="gasoil-form" style="margin-bottom:18px;">
        <div style="display:flex;gap:.9em;">
          <input type="text" id="gasoil-mac" placeholder="Machine/Référence..." required>
          <input type="text" id="gasoil-sh" placeholder="Service Heure">
          <input type="number" id="gasoil-conso" placeholder="Conso (L)" min="0" required>
          <input type="date" id="gasoil-date" value="${nowDate()}">
          <button type="submit">Ajouter</button>
        </div>
      </form>
      <div class="product-list" id="gasoil-prodlist"></div>
    </div>
  `;
  // Get gasoil total
  function renderGasoilDetail(doc){
    let qty = doc.exists ? doc.data().qty||0 : 0;
    let maxQty = doc.exists ? doc.data().maxQty||40000 : 40000;
    let percent = Math.min(100, Math.round((qty/(maxQty||1))*100));
    let barcolor = percent>66? "var(--fullness-ok)" : percent>33? "var(--fullness-mid)" : "var(--fullness-low)";
    document.getElementById("gas-detail").innerHTML = `
      <img src="https://img.icons8.com/3d-fluency/64/fuel-tank.png" style="border-radius:16px;background:white;margin-right:10px;vertical-align:middle;">
      <div style="display:inline-block;vertical-align:middle;">
      <div style="font-size:1.13em;font-weight:700;color:var(--accent2);margin-bottom:4px;">${qty} L / ${maxQty} L</div>
      <div style="display:flex;align-items:center;gap:.8em;">
        <div class="prod-meter-bar-wrap" style="width:160px;"><div class="prod-meter-bar" style="width:${percent}%;background:${barcolor};"></div></div>
        <span class="meter-percent">${percent}%</span>
      </div>
      </div>
      <div style="font-size:1em;color:#9a9bb0;margin-top:9px;">Dernière mise à jour : ${doc.exists && doc.data().date || "--"}</div>
    `;
  }
  db.collection("gasoil_total").doc("global").onSnapshot(renderGasoilDetail);
  // Edit gasoil total modal
  document.getElementById("add-gas-btn").onclick = async ()=>{
    let doc = await db.collection("gasoil_total").doc("global").get();
    document.getElementById("modal-bg").classList.add("show");
    document.getElementById("modal-title").textContent = "Editer Total Gasoil";
    document.getElementById("prod-name").value = "Diesel Fuel";
    document.getElementById("prod-cat").value = "Diesel";
    document.getElementById("prod-qty").value = doc.exists?doc.data().qty||0:0;
    document.getElementById("prod-maxqty").value = doc.exists?doc.data().maxQty||40000:40000;
    document.getElementById("prod-desc").value = doc.exists?doc.data().desc||"":"";
    document.getElementById("prod-img").value = doc.exists?doc.data().image||catImages["Gasoil"]:"";
    document.getElementById("modal-delete").style.display="none";
    // Save
    document.getElementById("edit-modal").onsubmit = async function(evt){
      evt.preventDefault();
      let data = {
        qty: Number(document.getElementById("prod-qty").value),
        maxQty: Number(document.getElementById("prod-maxqty").value)||40000,
        desc: document.getElementById("prod-desc").value,
        image: document.getElementById("prod-img").value,
        date: nowDate(),
        user: getUser()
      };
      await db.collection("gasoil_total").doc("global").set(data);
      await db.collection("log_activity").add({act:"Maj Gasoil total",...data,timestamp:firebase.firestore.FieldValue.serverTimestamp()});
      closeModal();
    };
  };
  // Consumption list
  db.collection("log_gasoil").orderBy("date","desc").limit(30).onSnapshot(qs=>{
    const list = qs.docs.map(doc=>({...doc.data(),_id:doc.id}));
    document.getElementById('gasoil-prodlist').innerHTML = list.length ?
      list.map(d=>`
        <div class="product-card">
          <img src="https://img.icons8.com/3d-fluency/64/fuel-tank.png" class="prod-img">
          <div class="prod-details">
            <div class="prod-name">${d.mac}</div>
            <div class="prod-cat">SH: ${d.sh}</div>
            <div class="prod-desc">Conso: <b>${d.conso}L</b> ${d.date||""}</div>
            <div style="font-size:.94em;color:#999;">Utilisateur: ${d.user||""}</div>
          </div>
        </div>
      `).join("") :
      `<div style="padding:1.2em;text-align:center;color:#888">Aucun log de consommation</div>`;
  });
  // Add consumption
  document.getElementById("gasoil-form").onsubmit=async function(ev){
    ev.preventDefault();
    let data = {
      mac: document.getElementById("gasoil-mac").value,
      sh: document.getElementById("gasoil-sh").value,
      conso: Number(document.getElementById("gasoil-conso").value),
      date: document.getElementById("gasoil-date").value,
      user: getUser()
    };
    let doc = await db.collection("gasoil_total").doc("global").get();
    let newQty = doc.exists ? ((doc.data().qty||0)-data.conso) : 0;
    if(newQty<0)newQty=0;
    await db.collection("gasoil_total").doc("global").set({...doc.data(),qty:newQty});
    await db.collection("log_gasoil").add(data);
    await db.collection("log_activity").add({act:"Conso Gasoil",...data,timestamp:firebase.firestore.FieldValue.serverTimestamp()});
    document.getElementById("gasoil-form").reset();
    document.getElementById("gasoil-date").value=nowDate();
  };
}

// === ACTIVITY PANEL ===
function loadHistoryPanel(){
  const dst = document.getElementById("history-panel");
  dst.innerHTML = `<div class="panel-card"><div class="section-title"><img src="https://img.icons8.com/ios-filled/32/b6bac8/list.png">Historique des actions</div>
  <div style="overflow-x:auto;">
    <table style="width:100%;border-collapse:collapse;margin-top:16px;">
      <thead><tr style="background:#f3f6fa;color:var(--accent);font-weight:600;">
        <th>Date/Heure</th><th>Action</th><th>User</th><th>Détail</th>
      </tr></thead>
      <tbody id="activity-tbody"></tbody>
    </table>
  </div>
  </div>`;
  db.collection("log_activity").orderBy("timestamp","desc").limit(50).onSnapshot(qs=>{
    document.getElementById("activity-tbody").innerHTML = qs.docs.map(doc=>{
      const d = doc.data();
      return `<tr style="background:#f8f9fb;">
        <td>${d.timestamp?(d.timestamp.toDate?d.timestamp.toDate().toLocaleString():d.timestamp):""}</td>
        <td>${d.act||""}</td>
        <td>${d.user||""}</td>
        <td>${Object.entries(d).filter(([k])=>!['act','user','timestamp'].includes(k)).map(([k,v])=>`${k}: ${v}`).join(' | ')}</td>
      </tr>`;
    }).join('');
  });
}

// INIT FIRST PANEL
function initApp(){
  loadPanel("dashboard");
}

</script>
</body>
</html>
